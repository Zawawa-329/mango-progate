<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header>
    <h1><a href="/dashboard">Limit Kakeibo</a></h1>
    <nav>
      <% if (user) { %>
        <div class="dropdown">
          <button class="dropdown-toggle">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;"><path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z" fill="white"/></svg>
            <span><%= user.email %></span>
          </button>
          <div class="dropdown-content">
            <a href="/register">åå…¥/æ”¯å‡ºç™»éŒ²</a>
            <a href="/map">æ”¯å‡ºãƒãƒƒãƒ—</a>
            <a href="/logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
          </div>
        </div>
      <% } %>
    </nav>
    <p class="balance-display">
      <% if (balance && typeof balance.balance !== 'undefined') { %>
        ç¾åœ¨ã®æ®‹é«˜: <span class="amount"><%= balance.balance %></span> å††
        <span class="date">ï¼ˆ<%= new Date(balance.updated_at).toLocaleString() %> æ™‚ç‚¹ï¼‰</span>
      <% } else { %>
        ç¾åœ¨ã®æ®‹é«˜ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“
      <% } %>
    </p>
  </header>

  <main>
    <%
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      const allTransactions = [...paypays, ...comecomes];

      function isThisMonth(dateStr) { const d = new Date(dateStr); return d.getFullYear() === year && d.getMonth() === month; }
      function isIncome(t) { return t.type.includes('åå…¥') || t.type.includes('å…¥é‡‘') || t.type.includes('income') || t.type.includes('ãŠå°é£ã„') || t.type.includes('ãƒã‚¤ãƒˆ'); }
      function isExpense(t) { return t.type.includes('æ”¯å‡º') || t.type.includes('å‡ºé‡‘') || t.type.includes('expense') || t.type.includes('ã‚µãƒ–ã‚¹ã‚¯') || t.type.includes('å˜ç™º'); }
      
      const monthTransactions = allTransactions.filter(t => isThisMonth(t.date));
      const incomeSum = monthTransactions.filter(isIncome).reduce((sum, t) => sum + Number(t.amount), 0);
      const expenseSum = monthTransactions.filter(isExpense).reduce((sum, t) => sum + Number(t.amount), 0);
      const diff = incomeSum - expenseSum;
    %>

    <section class="calendar-section">
      <form method="get" action="/dashboard">
        <label>å¹´
          <select name="year">
            <% for(let y=2020; y<=2030; y++) { %>
              <option value="<%= y %>" <%= year === y ? 'selected' : '' %>><%= y %></option>
            <% } %>
          </select>
        </label>
        <label>æœˆ
          <select name="month">
            <% for(let m=1; m<=12; m++) { %>
              <option value="<%= m %>" <%= month + 1 === m ? 'selected' : '' %>><%= m %></option>
            <% } %>
          </select>
        </label>
        <button type="submit">è¡¨ç¤º</button>
      </form>

      <h2><%= year %>å¹´ <%= month + 1 %>æœˆ ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>

      <div class="monthly-summary">
        <span style="margin-right:1.5em;">åå…¥åˆè¨ˆ: <span class="amount income"><%= incomeSum %></span> å††</span>
        <span style="margin-right:1.5em;">æ”¯å‡ºåˆè¨ˆ: <span class="amount expense"><%= expenseSum %></span> å††</span>
        <span>å·®é¡: <span class="amount <%= diff >= 0 ? 'positive-diff' : 'negative-diff' %>"><%= diff %></span> å††</span>
      </div>

      <div class="calendar-grid">
        <% const daysOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ']; %>
        <% daysOfWeek.forEach(day => { %>
          <div class="calendar-cell header"><%= day %></div>
        <% }); %>

        <%
          const firstDay = new Date(year, month, 1);
          const lastDay = new Date(year, month + 1, 0);
          const numDays = lastDay.getDate();
          const startWeekday = firstDay.getDay();
          const totalCells = Math.ceil((startWeekday + numDays) / 7) * 7;
          let dayCounter = 1;
        %>

        <% for (let i = 0; i < totalCells; i++) { %>
          <% if (i < startWeekday || dayCounter > numDays) { %>
            <div class="calendar-cell empty"></div>
          <% } else {
              const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayCounter).padStart(2, '0')}`;
              const dayTransactions = allTransactions.filter(t => t.date && t.date.startsWith(dateStr));
              
              const incomeTotal = dayTransactions.filter(isIncome).reduce((sum, t) => sum + Number(t.amount), 0);
              const expenseTotal = dayTransactions.filter(isExpense).reduce((sum, t) => sum + Number(t.amount), 0);
          %>
            <div class="calendar-cell" data-date="<%= dateStr %>">
              <div class="date-number"><%= dayCounter %></div>
              <div class="daily-summary">
                <% if(incomeTotal > 0) { %><div class="income">ï¼‹<%= incomeTotal %>å††</div><% } %>
                <% if(expenseTotal > 0) { %><div class="expense">ï¼<%= expenseTotal %>å††</div><% } %>
              </div>
            </div>
          <% dayCounter++; } %>
        <% } %>
      </div>
    </section>
  </main>
  <% if (aiComment) { %>
      <footer>
        <div class="ai-comment">
          <h3>ä»Šæœˆã®AIã‚³ãƒ¡ãƒ³ãƒˆ</h3>
          <p><%= aiComment %></p>
        </div>
      </footer>
    <% } %>
  <div id="details-modal" class="modal-overlay" style="display: none;">
    <div class="modal-box">
      <button id="modal-close-btn" class="modal-close-btn">&times;</button>
      <h3 id="modal-date"></h3>
      <div id="modal-content">
        </div>
    </div>
  </div>
    <script>
    const dropdownToggle = document.querySelector('.dropdown-toggle');
    const dropdownContent = document.querySelector('.dropdown-content');
    if (dropdownToggle && dropdownContent) {
        dropdownToggle.addEventListener('click', function(event) {
        dropdownContent.classList.toggle('show');
        event.stopPropagation(); 
        });
        window.addEventListener('click', function(event) {
        if (dropdownContent.classList.contains('show')) {
            dropdownContent.classList.remove('show');
        }
        });
    }
  </script>
  <script>
    // ãƒšãƒ¼ã‚¸ä¸Šã®ã™ã¹ã¦ã®å–å¼•ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    // server.tsã®ä¿®æ­£ã«ã‚ˆã‚Šã€å„å–å¼•ã«source_tableãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå«ã¾ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
    const allTransactionsForModal = <%- JSON.stringify([...paypays, ...comecomes]) %>;

    // å¿…è¦ãªHTMLè¦ç´ ã‚’å–å¾—
    const modal = document.getElementById('details-modal');
    const modalDate = document.getElementById('modal-date');
    const modalContent = document.getElementById('modal-content');
    const closeModalBtn = document.getElementById('modal-close-btn');
    const dayCells = document.querySelectorAll('.calendar-cell');

    // å„æ—¥ä»˜ã‚»ãƒ«ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
    dayCells.forEach(cell => {
      cell.addEventListener('click', () => {
        const dateStr = cell.dataset.date; // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ—¥ä»˜ (e.g., "2025-06-22")
        
        // ãã®æ—¥ã®å–å¼•ã ã‘ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        const dailyTransactions = allTransactionsForModal.filter(t => t.date && t.date.startsWith(dateStr));

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ—¥ä»˜ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š
        modalDate.textContent = `${new Date(dateStr).toLocaleDateString()} ã®è©³ç´°`;

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å†…å®¹ã‚’ç”Ÿæˆ
        modalContent.innerHTML = ''; // ä¸€æ—¦ç©ºã«ã™ã‚‹
        if (dailyTransactions.length > 0) {
          dailyTransactions.forEach(tx => {
            const isExpense = tx.type.includes('æ”¯å‡º') || tx.type.includes('expense') || tx.type.includes('ã‚µãƒ–ã‚¹ã‚¯') || tx.type.includes('å˜ç™º');
            const displaySign = isExpense ? 'ï¼' : 'ï¼‹';
            const displayAmount = Number(tx.amount).toLocaleString(); // é‡‘é¡ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

            const transactionHtml = `
              <div class="modal-transaction">
                <div class="modal-transaction-header">
                  <span>${tx.description || tx.type}</span>
                  <span>${displaySign}${displayAmount} å††</span>
                </div>
                <div class="modal-transaction-body">
                  ${tx.photo_filename ? `<img src="/uploads/${tx.photo_filename}" class="modal-transaction-photo">` : ''}
                  <div>
                    ${tx.location_name ? `<p class="transaction-location">ğŸ“${tx.location_name}</p>` : ''}
                    <a href="/${tx.source_table === 'paypay' ? 'edit-paypay' : 'edit-comecome'}/${tx.id}">ç·¨é›†</a>
                   <a href="/${tx.source_table === 'paypay' ? 'delete-paypay' : 'delete-comecome'}/${tx.id}" onclick="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');" style="color: #d9534f;">å‰Šé™¤</a>
                  </div>
                </div>
              </div>
            `;
            modalContent.innerHTML += transactionHtml;
          });
        } else {
          modalContent.innerHTML = '<p>ã“ã®æ—¥ã®åå…¥/æ”¯å‡ºã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        modal.style.display = 'flex';
      });
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹å‡¦ç†
    function closeModal() {
      modal.style.display = 'none';
    }

    closeModalBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (event) => {
      // èƒŒæ™¯ã®é»’ã„éƒ¨åˆ†ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã ã‘é–‰ã˜ã‚‹
      if (event.target === modal) {
        closeModal();
      }
    });
  </script>
</body>
</html>