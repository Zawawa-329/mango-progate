<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>カレンダー表示</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header>
      <h1>カレンダー</h1>
      <nav>
        <a href="/">トップ</a> |
        <a href="/register">登録ページ</a>
      </nav>
      <% if (balance && typeof balance.balance !== 'undefined') { %>
        <p style="font-weight:bold; color:#a68076; background:#fff3e6; border:2px solid #eac4af; border-radius:10px; display:inline-block; padding:0.5em 1.2em; margin-top:1em; margin-bottom:0; font-size:1.2em;">
          現在の残高: <span style="color:#efc3c2;"><%= balance.balance %></span> 円
          <span style="font-size:0.8em; color:#a68076;">（<%= new Date(balance.updated_at).toLocaleString() %> 時点）</span>
        </p>
      <% } else { %>
        <p style="font-weight:bold; color:#a68076; background:#fff3e6; border:2px solid #eac4af; border-radius:10px; display:inline-block; padding:0.5em 1.2em; margin-top:1em; margin-bottom:0; font-size:1.2em;">
          現在の残高は登録されていません
        </p>
      <% } %>
    </header>
    <main>
      <section class="calendar-section">
        <!-- 年月選択フォーム追加 -->
        <form method="get" action="/calendar" style="margin-bottom: 1em; display: flex; gap: 1em; align-items: center;">
          <label>
            年
            <select name="year">
              <% for(let y = 2020; y <= 2030; y++) { %>
                <option value="<%= y %>" <%= currentDate.getFullYear() === y ? 'selected' : '' %>><%= y %></option>
              <% } %>
            </select>
          </label>
          <label>
            月
            <select name="month">
              <% for(let m = 1; m <= 12; m++) { %>
                <option value="<%= m %>" <%= currentDate.getMonth() + 1 === m ? 'selected' : '' %>><%= m %></option>
              <% } %>
            </select>
          </label>
          <button type="submit">表示</button>
        </form>
        <h2><%= currentDate.getFullYear() %>年 <%= currentDate.getMonth() + 1 %>月 のカレンダー</h2>
        <div class="calendar-grid">
          <% const daysOfWeek = ['日', '月', '火', '水', '木', '金', '土']; %>
          <% daysOfWeek.forEach(day => { %>
            <div class="calendar-cell header"><%= day %></div>
          <% }) %>
          <% 
             // Generate days for current month
             const year = currentDate.getFullYear();
             const month = currentDate.getMonth();
             const firstDay = new Date(year, month, 1);
             const lastDay = new Date(year, month + 1, 0);
             const numDays = lastDay.getDate();
             const startWeekday = firstDay.getDay();
             let dayCounter = 1;
             const totalCells = Math.ceil((startWeekday + numDays) / 7) * 7;
          %>
          <% for(let i = 0; i < totalCells; i++) { %>
            <% if(i < startWeekday || dayCounter > numDays) { %>
              <div class="calendar-cell empty"></div>
            <% } else { 
                 const dateStr = new Date(year, month, dayCounter).toISOString().split('T')[0];
                 const dayPaypays = paypays.filter(t => t.date === dateStr);
                 const dayComecomes = comecomes.filter(t => t.date === dateStr);
            %>
              <div class="calendar-cell">
                <div class="date-number"><%= dayCounter %></div>
                <% dayPaypays.forEach(tx => { %>
                  <div class="transaction">
                    <span><%= tx.description || (tx.type === 'credit-card' ? 'クレジットカード' : '定期支払い') %></span>: <%= tx.amount %> 円
                    [<a href="/edit-paypay/<%= tx.id %>">編集</a>]
                    [<a href="/delete-paypay/<%= tx.id %>" onclick="return confirm('削除しますか？');">削除</a>]
                  </div>
                <% }) %>
                <% dayComecomes.forEach(tx => { %>
                  <div class="transaction">
                    <span><%= tx.description || (tx.type === 'credit-card' ? 'クレジットカード' : '定期支払い') %></span>: <%= tx.amount %> 円
                    [<a href="/edit-comecome/<%= tx.id %>">編集</a>]
                    [<a href="/delete-comecome/<%= tx.id %>" onclick="return confirm('削除しますか？');">削除</a>]
                  </div>
                  <% }) %>
              </div>
              <% dayCounter++ %>
            <% } %>
          <% } %>
        </div>
      </section>
    </main>
  </body>
</html>
