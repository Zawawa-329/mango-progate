<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>カレンダー表示</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header>
      <h1>カレンダー</h1>
      <nav>
        <a href="/">トップ</a> |
        <a href="/register">登録ページ</a>
      </nav>
      <% if (balance && balance.balance !== undefined) { %>
        <p>最新の口座残高: <strong><%= balance.balance %></strong> 円（<%= new Date(balance.updated_at).toLocaleString() %> 登録）</p>
      <% } %>
    </header>
    <main>
      <section class="calendar-section">
        <h2><%= currentDate.getFullYear() %>年 <%= currentDate.getMonth() + 1 %>月 のカレンダー</h2>
        <div class="calendar-grid">
          <% const daysOfWeek = ['日', '月', '火', '水', '木', '金', '土']; %>
          <% daysOfWeek.forEach(day => { %>
            <div class="calendar-cell header"><%= day %></div>
          <% }) %>
          <% 
             // Generate days for current month
             const year = currentDate.getFullYear();
             const month = currentDate.getMonth();
             const firstDay = new Date(year, month, 1);
             const lastDay = new Date(year, month + 1, 0);
             const numDays = lastDay.getDate();
             const startWeekday = firstDay.getDay();
             let dayCounter = 1;
             const totalCells = Math.ceil((startWeekday + numDays) / 7) * 7;
          %>
          <% for(let i = 0; i < totalCells; i++) { %>
            <% if(i < startWeekday || dayCounter > numDays) { %>
              <div class="calendar-cell empty"></div>
            <% } else { 
                 const dateStr = new Date(year, month, dayCounter).toISOString().split('T')[0];
                 const dayPaypays = paypays.filter(t => t.date === dateStr);
                 const dayComecomes = comecomes.filter(t => t.date === dateStr);
            %>
              <div class="calendar-cell">
                <div class="date-number"><%= dayCounter %></div>
                <% dayPaypays.forEach(tx => { %>
                  <div class="transaction">
                    <span><%= tx.description || (tx.type === 'credit-card' ? 'クレジットカード' : '定期支払い') %></span>: <%= tx.amount %> 円
                    [<a href="/edit-paypay/<%= tx.id %>">編集</a>]
                    [<a href="/delete-paypay/<%= tx.id %>" onclick="return confirm('削除しますか？');">削除</a>]
                  </div>
                <% }) %>
                <% dayComecomes.forEach(tx => { %>
                  <div class="transaction">
                    <span><%= tx.description || (tx.type === 'credit-card' ? 'クレジットカード' : '定期支払い') %></span>: <%= tx.amount %> 円
                    [<a href="/edit-comecome/<%= tx.id %>">編集</a>]
                    [<a href="/delete-comecome/<%= tx.id %>" onclick="return confirm('削除しますか？');">削除</a>]
                  </div>
                  <% }) %>
              </div>
              <% dayCounter++ %>
            <% } %>
          <% } %>
        </div>
      </section>
    </main>
  </body>
</html>
